/**
 * Another angular directive for selecting date and time ranges
 * @version v0.1.0 - 2015-07-21
 * @author Gabriela Vazquez <gabs.vz@gmail.com>
 **/
(function(){"use strict";function a(a){return"hour"===a.duration.unit||"minutes"===a.duration.unit||"day"==a.duration.unit&&1==a.duration.value?!0:!1}function b(a,b){var c=new moment(a),d=new moment(b);return d.diff(c,"hours")}function c(a){var b=a||new Date,c=b+"",d=c.match(/\(([^\)]+)\)$/)||c.match(/([A-Z]+) [\d]{4}$/);return d&&(d=d[1].match(/[A-Z]/g).join("")),d||(d=""),d}function d(a,b,c){function d(a){var b=i.indexOf(a);return 0>b||b>i.length-2?i[i.length-1]:i[b+1]}function e(a){switch(a){case"second":return 1e3;case"minute":return 6e4;case"hour":return 36e5;case"day":return 864e5;case"week":return 6048e5;case"month":return 2592e6;default:return NaN}}function f(a){if(_.isUndefined(a)&&(a=h.timeUnit),i.indexOf(a)<0)return void 0;var b=e(a),c=moment(h.from).toDate().getTime(),d=moment(h.to).toDate().getTime(),f=d-c;return Math.floor(f/b)}function g(a){var b=f(a);return b?f(a)<h.maxResolution:!1}var h,i=["second","minute","hour","day","week","month"];return h={from:a,to:b,timeUnit:c||"second",maxResolution:200,selectedRange:"custom",suggestedTimeUnit:function(){for(var a=h.timeUnit,b=i[i.length-1];a!==b&&!g(a);)a=d(a);return a},suggestedRange:function(){var a=h.suggestedTimeUnit(),b={from:moment(h.from).startOf(a).valueOf(),to:moment(h.to).startOf(a).valueOf(),intersects:function(a){return moment(a).valueOf()>=b.from&&moment(a).valueOf()<=b.to}};return b}}}function e(a,b){var c,e,f;if(a.duration&&0===a.duration.offset)c=moment(),e=moment().startOf(a.duration.unit).subtract(a.duration.value-1,a.duration.unit);else if(a.duration&&a.duration.offset>0){var g=(new moment).subtract(a.duration.offset,a.duration.unit),h=(new moment).subtract(a.duration.offset-1,a.duration.unit);e=moment(g).startOf(a.duration.unit),c=moment(h).startOf(a.duration.unit)}else c=moment(),e=moment().subtract(a.duration.value,a.duration.unit);f=d(e.valueOf(),c.valueOf());var i=b||f.suggestedTimeUnit();return f.to=moment(f.to).startOf(i).valueOf(),f.from=moment(f.to).subtract(a.duration.value,a.duration.unit).valueOf(),f.timeUnit=i,f.selectedRange=a,f}function f(f,g){return{restrict:"E",replace:!0,templateUrl:"dt-picker.html",scope:{range:"=",options:"=",rangeDictionary:"="},link:function(k,l){function m(a,b){var c=moment(b).diff(moment(a),"hours");c>36&&200>c?k.internalRangeObject.selectedRange.timeUnits=["hour","day"]:delete k.internalRangeObject.selectedRange.timeUnits}function n(){if("Time Range"===k.internalRangeObject.selectedRange.label){var a=moment(k.internalRangeObject.from),c=moment(k.internalRangeObject.to);k.selectedFrom=g.find(k.hours,{value:a.hour()}),10===c.diff(a,"minutes")?k.selectedDuration=g.find(k.durations,{value:10,unit:"minutes"}):k.selectedDuration=g.find(k.durations,{value:c.diff(a,"hours"),unit:"hours"})}else if("Last Hour"===k.internalRangeObject.selectedRange.label)k.selectedFrom=g.find(k.hours,{value:-1}),k.selectedDuration=g.find(k.durations,{value:1,unit:"hours"});else if("Last 10 Minutes"===k.internalRangeObject.selectedRange.label)k.selectedFrom=g.find(k.hours,{value:-10}),k.selectedDuration=g.find(k.durations,{value:10,unit:"minutes"});else{var d=new moment(k.internalRangeObject.suggestedRange().from).hour();k.selectedFrom=g.find(k.hours,{value:d});var e=b(k.internalRangeObject.from,k.internalRangeObject.to);k.selectedDuration=g.find(k.durations,{value:e,unit:"hours"})}var h=new Date(k.internalRangeObject.suggestedRange().from);t=!0,f(l.find(".single-calendar-container")).datepick("setDate",h)}function o(){var a=k.internalRangeObject.suggestedRange().from,b=new Date(a),c=moment(a).month(),d=moment(a).year(),e=new Date(k.internalRangeObject.suggestedRange().to);v=!1,u=!0,f(l.find(".double-calendar-container")).datepick("option","minDate","-6m"),f(l.find(".double-calendar-container")).datepick("option","maxDate",0),f(l.find(".double-calendar-container")).datepick("setDate",b,e),f(l.find(".double-calendar-container")).datepick("showMonth",d,c),m(k.internalRangeObject.suggestedRange().from,k.internalRangeObject.suggestedRange().to)}function p(){k.isTimeRange?n():o()}function q(b){if(k.internalRangeObject.selectedRange){if(k.internalRangeObject.selectedRange.custom){if("date"===k.internalRangeObject.selectedRange.custom){if(k.isTimeRange){var c=new moment(k.internalRangeObject.from).startOf("day"),f=new moment(k.internalRangeObject.to).endOf("day");k.internalRangeObject=d(c.valueOf(),f.valueOf()),k.internalRangeObject.selectedRange=g.find(k.dictionary,{custom:"date"}),k.isTimeRange=!1}}else if(!k.isTimeRange){var c=new moment(k.internalRangeObject.from).startOf("day"),f=new moment(k.internalRangeObject.from).startOf("day").add(1,"day");k.internalRangeObject=d(c.valueOf(),f.valueOf()),k.internalRangeObject.selectedRange=g.find(k.dictionary,{custom:"time"}),k.isTimeRange=!0}}else k.internalRangeObject=e(k.internalRangeObject.selectedRange,b?k.internalRangeObject.timeUnit:!1),k.isTimeRange=a(k.internalRangeObject.selectedRange);b||(k.internalRangeObject.timeUnit=k.internalRangeObject.suggestedTimeUnit())}}function r(a,b,c){k.internalRangeObject=d(a,b),k.internalRangeObject.selectedRange=g.find(k.dictionary,c),k.internalRangeObject.timeUnit=k.internalRangeObject.suggestedTimeUnit()}function s(){f(l.find(".single-calendar-container")).datepick({minDate:"-6m",maxDate:0,changeMonth:!1,dayNamesMin:["S","M","T","W","T","F","S"],prevText:'<span class="datepickImagePrevious"></span><span class="datepickTextNextPrevious">Prev</span>',nextText:'<span class="datepickTextNextPrevious">Next</span><span class="datepickImageNext"></span>',onSelect:k.singleDateSelected}),f(l.find(".double-calendar-container")).datepick({rangeSelect:!0,monthsToShow:2,minDate:"-6m",maxDate:0,changeMonth:!1,dayNamesMin:["S","M","T","W","T","F","S"],prevText:'<span class="datepickImagePrevious"></span><span class="datepickTextNextPrevious">Prev</span>',nextText:'<span class="datepickTextNextPrevious">Next</span><span class="datepickImageNext"></span>',onSelect:k.dateRangeSelected}),k.rangeDictionary?k.dictionary=k.rangeDictionary:k.dictionary=h,g.find(k.dictionary,{label:"Last 10 Minutes"})?(k.hours=[{value:-10,unit:"minute",label:"Ten minutes ago"}].concat(i),k.durations=[{value:10,unit:"minutes",label:"10 minutes"}].concat(j)):(k.hours=i,k.durations=j),k.options&&k.options.hideCustom&&g.remove(k.dictionary,{custom:"date"}),k.maxRange=k.options&&k.options.maxRange||31,k.internalRangeObject={},k.selectRangeOption(g.find(k.dictionary,{preselected:!0})||k.dictionary[0]),k.threeLetterTimezoneLabel=c();var a=e(k.internalRangeObject.selectedRange);k.range={from:a.from,to:a.to,timeUnit:a.suggestedTimeUnit()},k.savedRange=k.internalRangeObject.selectedRange}var t,u;k.singleDateSelected=function(a){if(a&&a[0]){if(t)return void(t=!1);var b=new moment(a[0]),c=new moment(k.internalRangeObject.from);c.year(b.year()).month(b.month()).date(b.date());var d=new moment(c.valueOf()).add(k.selectedDuration.value,"hours");r(c.valueOf(),d.valueOf(),{custom:"time"}),k.$apply()}};var v;k.dateRangeSelected=function(a){if(a&&a.length){if(u)return void(u=!1);var b,c;if(v)b=v,c=moment(a[1]).endOf("day").valueOf(),f(l.find(".double-calendar-container")).datepick("option","minDate","-6m"),f(l.find(".double-calendar-container")).datepick("option","maxDate",0),f(l.find(".double-calendar-container")).datepick("setDate",new Date(b),new Date(c)),v=!1;else{b=moment(a[0]).startOf("day").valueOf(),c=moment(a[1]).endOf("day").valueOf(),v=b;var d=moment(b).add(k.maxRange,"days").valueOf(),e=g.min([d,moment().valueOf()]);f(l.find(".double-calendar-container")).datepick("option","minDate",new Date(b)),f(l.find(".double-calendar-container")).datepick("option","maxDate",new Date(e))}r(b,c,{custom:"date"}),m(b,c),k.$apply()}},k.selectRangeOption=function(a){k.internalRangeObject.selectedRange=a,q(),p()},k.configure=function(){k.internalRangeObject.selectedRange=k.savedRange,k.internalRangeObject.from=k.range.from,k.internalRangeObject.to=k.range.to,k.internalRangeObject.timeUnit=k.range.timeUnit,q(!0),p(),k.configuring=!0},k.selectFrom=function(a){if(-1===a.value)k.selectRangeOption(g.find(k.dictionary,{label:"Last Hour"}));else if(-10===a.value)k.selectRangeOption(g.find(k.dictionary,{label:"Last 10 Minutes"}));else{k.selectedFrom=a;var b=new moment(k.internalRangeObject.from);b.hour(a.value).minute(0).second(0).millisecond(0);var c=new moment(b.valueOf()).add(k.selectedDuration.value,k.selectedDuration.unit);r(b.valueOf(),c.valueOf(),{custom:"time"})}},k.selectDuration=function(a){k.selectedDuration=a;var b=new moment(k.internalRangeObject.from).add(k.selectedDuration.value,k.selectedDuration.unit);r(k.internalRangeObject.from,b.valueOf(),{custom:"time"})},k.selectTimeUnit=function(a){k.internalRangeObject.timeUnit=a,q(!0)},k.close=function(){k.configuring=!1},k.refresh=function(){k.internalRangeObject.selectedRange=k.savedRange,q(!0),k.save()},k.save=function(){k.savedRange=k.internalRangeObject.selectedRange,k.range.from=k.internalRangeObject.from,k.range.to=k.internalRangeObject.to,k.range.timeUnit=k.internalRangeObject.timeUnit,k.configuring=!1},s()}}}function g(a,b,c){var d=a.module("dt-picker",[]);return d.factory("jQuery",[function(){return b}]),d.factory("lodash",[function(){return c}]),d.factory("dtPicker.service",[function(){return{version:"0.1.0"}}]),d.directive("dtPicker",["jQuery","lodash",f]),d}var h=[{label:"Last Hour",duration:{unit:"hour",value:1}},{label:"Last 24 Hours",duration:{unit:"day",value:1},preselected:!0},{label:"Last 7 Days",duration:{unit:"week",value:1}},{label:"Date Range",custom:"date"},{label:"Time Range",custom:"time"}],i=[{value:-1,unit:"hour",label:"An hour ago"},{value:0,label:"0:00"},{value:1,label:"1:00"},{value:2,label:"2:00"},{value:3,label:"3:00"},{value:4,label:"4:00"},{value:5,label:"5:00"},{value:6,label:"6:00"},{value:7,label:"7:00"},{value:8,label:"8:00"},{value:9,label:"9:00"},{value:10,label:"10:00"},{value:11,label:"11:00"},{value:12,label:"12:00"},{value:13,label:"13:00"},{value:14,label:"14:00"},{value:15,label:"15:00"},{value:16,label:"16:00"},{value:17,label:"17:00"},{value:18,label:"18:00"},{value:19,label:"19:00"},{value:20,label:"20:00"},{value:21,label:"21:00"},{value:22,label:"22:00"},{value:23,label:"23:00"}],j=[{value:1,unit:"hours",label:"1 hour"},{value:2,unit:"hours",label:"2 hours"},{value:3,unit:"hours",label:"3 hours"},{value:6,unit:"hours",label:"6 hours"},{value:12,unit:"hours",label:"12 hours"},{value:24,unit:"hours",label:"24 hours"},{value:48,unit:"hours",label:"48 hours"}];"function"==typeof define&&"object"==typeof define.amd&&define.amd?define(["angular","jQuery","datepick","lodash","moment","partials"],function(a,b,c,d,e){return g(a,b,_)}):"undefined"!=typeof angular&&null!==angular&&g(angular,$,_)}).call(this),angular.module("partials",["dt-picker.html"]),angular.module("dt-picker.html",[]).run(["$templateCache",function(a){a.put("dt-picker.html",'<div class="date-time-picker">\n    <div class="picker-visible">\n        <div class="main-label-container left">\n            <a class="main-date-time-label" ng-class="configuring ? \'configuring\' : \'closed\'" ng-click="configure()">\n                <span class="dt-lighter">{{ range.from | date: \'EEE\' }}</span>\n                <span class="dt-bolder">{{ range.from | date: \'d MMM yyyy\' }}</span>\n                <span class="dt-lighter">{{ range.from | date: \'H:mm\' }}</span>\n                <span class="dt-bolder">&nbsp;&ndash;&nbsp;</span>\n                <span class="dt-lighter">{{ range.to | date: \'EEE\' }}</span>\n                <span class="dt-bolder">{{ range.to | date: \'d MMM yyyy\' }}</span>\n                <span class="dt-lighter">{{ range.to | date: \'H:mm\' }}</span>\n                <span class="dt-lighter">{{ threeLetterTimezoneLabel }}</span>\n            </a>\n        </div>\n        <div class="refresh-container right">\n            <button class="refresh-axdashboard btn btn-small" href="" ng-click="refresh()"\n                    analytics-on analytics-event="Analytics Dashboard Refresh"><i class="icon-apigeeStyle icon-refresh"></i></button>\n        </div>\n        <div class="clearfix"></div>\n    </div>\n    <div class="date-time-configure" ng-show="configuring">\n        <div class="sections">\n            <div class="date-range-selection" ng-hide="isTimeRange">\n                <div class="double-calendar-container"></div>\n            </div>\n            <div class="time-range-selection" ng-show="isTimeRange">\n                <div class="single-calendar-container"></div>\n                <div class="time-range-container">\n                    <div class="key-value-section">\n                        <span class="bold-label">From</span>\n                        <div class="btn-group">\n                            <button class="btn btn-small dropdown-toggle" data-toggle="dropdown">{{ selectedFrom.label }}<span class="caret"></span></button>\n                            <ul class="dropdown-menu">\n                                <li ng-repeat="hour in hours" ng-click="selectFrom(hour)"><a>{{ hour.label }}</a></li>\n                            </ul>\n                        </div>\n                    </div>\n                    <div class="key-value-section">\n                        <span class="bold-label">Duration</span>\n                        <div class="btn-group">\n                            <button class="btn btn-small dropdown-toggle" data-toggle="dropdown">{{ selectedDuration.label }}<span class="caret"></span></button>\n                            <ul class="dropdown-menu">\n                                <li ng-repeat="duration in durations" ng-click="selectDuration(duration)"><a>{{ duration.label }}</a></li>\n                            </ul>\n                        </div>\n                    </div>\n                    <div class="key-value-section">\n                        <span class="bold-label">To</span>\n                        <span class="label-text to-value">{{ internalRangeObject.suggestedRange().to | date: \'H:mm\' }}</span>\n                    </div>\n                </div>\n            </div>\n            <div class="section-configure">\n                <div class="key-value-section">\n                    <span class="bold-label">Range</span>\n                    <div class="btn-group">\n                        <button class="btn btn-small dropdown-toggle" data-toggle="dropdown">{{ internalRangeObject.selectedRange.label }}<span class="caret"></span></button>\n                        <ul class="dropdown-menu">\n                            <li ng-repeat="range in dictionary"><a ng-click="selectRangeOption(range)">{{ range.label }}</a></li>\n                        </ul>\n                    </div>\n                </div>\n                <div class="key-value-section">\n                    <span class="bold-label">Time Unit</span>\n                    <span class="label-text" ng-hide="internalRangeObject.selectedRange.timeUnits.length > 1">{{ internalRangeObject.timeUnit }}</span>\n                    <div class="btn-group" ng-show="internalRangeObject.selectedRange.timeUnits.length > 1">\n                        <button class="btn btn-small dropdown-toggle" data-toggle="dropdown">{{ internalRangeObject.timeUnit }}<span class="caret"></span>\n                        </button>\n                        <ul class="dropdown-menu">\n                            <li ng-repeat="unit in internalRangeObject.selectedRange.timeUnits" ng-click="selectTimeUnit(unit)"><a>{{ unit }}</a></li>\n                        </ul>\n                    </div>\n                </div>\n            </div>\n        </div>\n        <div class="bottom-section">\n            <div class="button-section">\n                <button class="btn btn-primary finish right" ng-click="save()">Apply</button>\n                <button class="btn finish right" ng-click="close()">Cancel</button>\n            </div>\n            <div class="selected-section">\n                <span class="bold-label">Selected</span>\n                <span class="label-text">{{ internalRangeObject.suggestedRange().from | date: \'EEE d MMM yyyy H:mm\' }} &nbsp;&ndash;&nbsp; {{ internalRangeObject.suggestedRange().to | date: \'EEE d MMM yyyy H:mm\' }} {{ threeLetterTimezoneLabel }}</span>\n            </div>\n        </div>\n    </div>\n</div>')}]);