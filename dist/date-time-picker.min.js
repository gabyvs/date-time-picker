/**
 * Another angular directive for selecting date and time ranges
 * @version v0.1.0 - 2015-07-21
 * @author Gabriela Vazquez <gabs.vz@gmail.com>
 **/
(function(){"use strict";function a(a){return"hour"===a.duration.unit||"minutes"===a.duration.unit||"day"==a.duration.unit&&1==a.duration.value?!0:!1}function b(a,b){var c=new moment(a),d=new moment(b);return d.diff(c,"hours")}function c(a){var b=a||new Date,c=b+"",d=c.match(/\(([^\)]+)\)$/)||c.match(/([A-Z]+) [\d]{4}$/);return d&&(d=d[1].match(/[A-Z]/g).join("")),d||(d=""),d}function d(a,b,c){function d(a){var b=i.indexOf(a);return 0>b||b>i.length-2?i[i.length-1]:i[b+1]}function e(a){switch(a){case"second":return 1e3;case"minute":return 6e4;case"hour":return 36e5;case"day":return 864e5;case"week":return 6048e5;case"month":return 2592e6;default:return NaN}}function f(a){if(_.isUndefined(a)&&(a=h.timeUnit),i.indexOf(a)<0)return void 0;var b=e(a),c=moment(h.from).toDate().getTime(),d=moment(h.to).toDate().getTime(),f=d-c;return Math.floor(f/b)}function g(a){var b=f(a);return b?f(a)<h.maxResolution:!1}var h,i=["second","minute","hour","day","week","month"];return h={from:a,to:b,timeUnit:c||"second",maxResolution:200,selectedRange:"custom",suggestedTimeUnit:function(){for(var a=h.timeUnit,b=i[i.length-1];a!==b&&!g(a);)a=d(a);return a},suggestedRange:function(){var a=h.suggestedTimeUnit(),b={from:moment(h.from).startOf(a).valueOf(),to:moment(h.to).startOf(a).valueOf(),intersects:function(a){return moment(a).valueOf()>=b.from&&moment(a).valueOf()<=b.to}};return b}}}function e(a,b){var c,e,f;if(a.duration&&0===a.duration.offset)c=moment(),e=moment().startOf(a.duration.unit).subtract(a.duration.value-1,a.duration.unit);else if(a.duration&&a.duration.offset>0){var g=(new moment).subtract(a.duration.offset,a.duration.unit),h=(new moment).subtract(a.duration.offset-1,a.duration.unit);e=moment(g).startOf(a.duration.unit),c=moment(h).startOf(a.duration.unit)}else c=moment(),e=moment().subtract(a.duration.value,a.duration.unit);f=d(e.valueOf(),c.valueOf());var i=b||f.suggestedTimeUnit();return f.to=moment(f.to).startOf(i).valueOf(),f.from=moment(f.to).subtract(a.duration.value,a.duration.unit).valueOf(),f.timeUnit=i,f.selectedRange=a,f}function f(f,g){return{restrict:"E",replace:!0,templateUrl:"dt-picker.html",scope:{range:"=",options:"=",rangeDictionary:"="},link:function(h,l){function m(a,b){var c=moment(b).diff(moment(a),"hours");c>36&&200>c?h.internalRangeObject.selectedRange.timeUnits=["hour","day"]:delete h.internalRangeObject.selectedRange.timeUnits}function n(){if("Time Range"===h.internalRangeObject.selectedRange.label){var a=moment(h.internalRangeObject.from),c=moment(h.internalRangeObject.to);h.selectedFrom=g.find(h.hours,{value:a.hour()}),10===c.diff(a,"minutes")?h.selectedDuration=g.find(h.durations,{value:10,unit:"minutes"}):h.selectedDuration=g.find(h.durations,{value:c.diff(a,"hours"),unit:"hours"})}else if("Last Hour"===h.internalRangeObject.selectedRange.label)h.selectedFrom=g.find(h.hours,{value:-1}),h.selectedDuration=g.find(h.durations,{value:1,unit:"hours"});else if("Last 10 Minutes"===h.internalRangeObject.selectedRange.label)h.selectedFrom=g.find(h.hours,{value:-10}),h.selectedDuration=g.find(h.durations,{value:10,unit:"minutes"});else{var d=new moment(h.internalRangeObject.suggestedRange().from).hour();h.selectedFrom=g.find(h.hours,{value:d});var e=b(h.internalRangeObject.from,h.internalRangeObject.to);h.selectedDuration=g.find(h.durations,{value:e,unit:"hours"})}var i=new Date(h.internalRangeObject.suggestedRange().from);t=!0,f(l.find(".single-calendar-container")).datepick("setDate",i)}function o(){var a=h.internalRangeObject.suggestedRange().from,b=new Date(a),c=moment(a).month(),d=moment(a).year(),e=new Date(h.internalRangeObject.suggestedRange().to);v=!1,u=!0,f(l.find(".double-calendar-container")).datepick("option","minDate","-6m"),f(l.find(".double-calendar-container")).datepick("option","maxDate",0),f(l.find(".double-calendar-container")).datepick("setDate",b,e),f(l.find(".double-calendar-container")).datepick("showMonth",d,c),m(h.internalRangeObject.suggestedRange().from,h.internalRangeObject.suggestedRange().to)}function p(){h.isTimeRange?n():o()}function q(b){if(h.internalRangeObject.selectedRange){if(h.internalRangeObject.selectedRange.custom){if("date"===h.internalRangeObject.selectedRange.custom){if(h.isTimeRange){var c=new moment(h.internalRangeObject.from).startOf("day"),f=new moment(h.internalRangeObject.to).endOf("day");h.internalRangeObject=d(c.valueOf(),f.valueOf()),h.internalRangeObject.selectedRange=g.find(h.dictionary,{custom:"date"}),h.isTimeRange=!1}}else if(!h.isTimeRange){var c=new moment(h.internalRangeObject.from).startOf("day"),f=new moment(h.internalRangeObject.from).startOf("day").add(1,"day");h.internalRangeObject=d(c.valueOf(),f.valueOf()),h.internalRangeObject.selectedRange=g.find(h.dictionary,{custom:"time"}),h.isTimeRange=!0}}else h.internalRangeObject=e(h.internalRangeObject.selectedRange,b?h.internalRangeObject.timeUnit:!1),h.isTimeRange=a(h.internalRangeObject.selectedRange);b||(h.internalRangeObject.timeUnit=h.internalRangeObject.suggestedTimeUnit())}}function r(a,b,c){h.internalRangeObject=d(a,b),h.internalRangeObject.selectedRange=g.find(h.dictionary,c),h.internalRangeObject.timeUnit=h.internalRangeObject.suggestedTimeUnit()}function s(){f(l.find(".single-calendar-container")).datepick({minDate:"-6m",maxDate:0,changeMonth:!1,dayNamesMin:["S","M","T","W","T","F","S"],prevText:'<span class="datepickImagePrevious"></span><span class="datepickTextNextPrevious">Prev</span>',nextText:'<span class="datepickTextNextPrevious">Next</span><span class="datepickImageNext"></span>',onSelect:h.singleDateSelected}),f(l.find(".double-calendar-container")).datepick({rangeSelect:!0,monthsToShow:2,minDate:"-6m",maxDate:0,changeMonth:!1,dayNamesMin:["S","M","T","W","T","F","S"],prevText:'<span class="datepickImagePrevious"></span><span class="datepickTextNextPrevious">Prev</span>',nextText:'<span class="datepickTextNextPrevious">Next</span><span class="datepickImageNext"></span>',onSelect:h.dateRangeSelected}),h.rangeDictionary?h.dictionary=h.rangeDictionary:h.dictionary=i,g.find(h.dictionary,{label:"Last 10 Minutes"})?(h.hours=[{value:-10,unit:"minute",label:"Ten minutes ago"}].concat(j),h.durations=[{value:10,unit:"minutes",label:"10 minutes"}].concat(k)):(h.hours=j,h.durations=k),h.options&&h.options.hideCustom&&g.remove(h.dictionary,{custom:"date"}),h.maxRange=h.options&&h.options.maxRange||31,h.internalRangeObject={},h.selectRangeOption(g.find(h.dictionary,{preselected:!0})||h.dictionary[0]),h.threeLetterTimezoneLabel=c();var a=e(h.internalRangeObject.selectedRange);h.range={from:a.from,to:a.to,timeUnit:a.suggestedTimeUnit()},h.savedRange=h.internalRangeObject.selectedRange}var t,u;h.singleDateSelected=function(a){if(a&&a[0]){if(t)return void(t=!1);var b=new moment(a[0]),c=new moment(h.internalRangeObject.from);c.year(b.year()).month(b.month()).date(b.date());var d=new moment(c.valueOf()).add(h.selectedDuration.value,"hours");r(c.valueOf(),d.valueOf(),{custom:"time"}),h.$apply()}};var v;h.dateRangeSelected=function(a){if(a&&a.length){if(u)return void(u=!1);var b,c;if(v)b=v,c=moment(a[1]).endOf("day").valueOf(),f(l.find(".double-calendar-container")).datepick("option","minDate","-6m"),f(l.find(".double-calendar-container")).datepick("option","maxDate",0),f(l.find(".double-calendar-container")).datepick("setDate",new Date(b),new Date(c)),v=!1;else{b=moment(a[0]).startOf("day").valueOf(),c=moment(a[1]).endOf("day").valueOf(),v=b;var d=moment(b).add(h.maxRange,"days").valueOf(),e=g.min([d,moment().valueOf()]);f(l.find(".double-calendar-container")).datepick("option","minDate",new Date(b)),f(l.find(".double-calendar-container")).datepick("option","maxDate",new Date(e))}r(b,c,{custom:"date"}),m(b,c),h.$apply()}},h.selectRangeOption=function(a){h.internalRangeObject.selectedRange=a,q(),p()},h.configure=function(){h.internalRangeObject.selectedRange=h.savedRange,h.internalRangeObject.from=h.range.from,h.internalRangeObject.to=h.range.to,h.internalRangeObject.timeUnit=h.range.timeUnit,q(!0),p(),h.configuring=!0},h.selectFrom=function(a){if(-1===a.value)h.selectRangeOption(g.find(h.dictionary,{label:"Last Hour"}));else if(-10===a.value)h.selectRangeOption(g.find(h.dictionary,{label:"Last 10 Minutes"}));else{h.selectedFrom=a;var b=new moment(h.internalRangeObject.from);b.hour(a.value).minute(0).second(0).millisecond(0);var c=new moment(b.valueOf()).add(h.selectedDuration.value,h.selectedDuration.unit);r(b.valueOf(),c.valueOf(),{custom:"time"})}},h.selectDuration=function(a){h.selectedDuration=a;var b=new moment(h.internalRangeObject.from).add(h.selectedDuration.value,h.selectedDuration.unit);r(h.internalRangeObject.from,b.valueOf(),{custom:"time"})},h.selectTimeUnit=function(a){h.internalRangeObject.timeUnit=a,q(!0)},h.close=function(){h.configuring=!1},h.refresh=function(){h.internalRangeObject.selectedRange=h.savedRange,q(!0),h.save()},h.save=function(){h.savedRange=h.internalRangeObject.selectedRange,h.range.from=h.internalRangeObject.from,h.range.to=h.internalRangeObject.to,h.range.timeUnit=h.internalRangeObject.timeUnit,h.configuring=!1},s()}}}function g(a,b,c){var d=a.module("dt-picker",[]);return d.run(["$templateCache",h]),d.factory("jQuery",[function(){return b}]),d.factory("lodash",[function(){return c}]),d.factory("dtPicker.service",[function(){return{version:"0.1.0"}}]),d.directive("dtPicker",["jQuery","lodash",f]),d}function h(a){a.put("dt-picker.html",'<div class="date-time-picker">\n    <div class="picker-visible">\n        <div class="main-label-container left">\n            <a class="main-date-time-label" ng-class="configuring ? \'configuring\' : \'closed\'" ng-click="configure()">\n                <span class="dt-lighter">{{ range.from | date: \'EEE\' }}</span>\n                <span class="dt-bolder">{{ range.from | date: \'d MMM yyyy\' }}</span>\n                <span class="dt-lighter">{{ range.from | date: \'H:mm\' }}</span>\n                <span class="dt-bolder">&nbsp;&ndash;&nbsp;</span>\n                <span class="dt-lighter">{{ range.to | date: \'EEE\' }}</span>\n                <span class="dt-bolder">{{ range.to | date: \'d MMM yyyy\' }}</span>\n                <span class="dt-lighter">{{ range.to | date: \'H:mm\' }}</span>\n                <span class="dt-lighter">{{ threeLetterTimezoneLabel }}</span>\n            </a>\n        </div>\n        <div class="refresh-container right">\n            <button class="refresh-axdashboard btn btn-small" href="" ng-click="refresh()"\n                    analytics-on analytics-event="Analytics Dashboard Refresh"><i class="icon-apigeeStyle icon-refresh"></i></button>\n        </div>\n        <div class="clearfix"></div>\n    </div>\n    <div class="date-time-configure" ng-show="configuring">\n        <div class="sections">\n            <div class="date-range-selection" ng-hide="isTimeRange">\n                <div class="double-calendar-container"></div>\n            </div>\n            <div class="time-range-selection" ng-show="isTimeRange">\n                <div class="single-calendar-container"></div>\n                <div class="time-range-container">\n                    <div class="key-value-section">\n                        <span class="bold-label">From</span>\n                        <div class="btn-group">\n                            <button class="btn btn-small dropdown-toggle" data-toggle="dropdown">{{ selectedFrom.label }}<span class="caret"></span></button>\n                            <ul class="dropdown-menu">\n                                <li ng-repeat="hour in hours" ng-click="selectFrom(hour)"><a>{{ hour.label }}</a></li>\n                            </ul>\n                        </div>\n                    </div>\n                    <div class="key-value-section">\n                        <span class="bold-label">Duration</span>\n                        <div class="btn-group">\n                            <button class="btn btn-small dropdown-toggle" data-toggle="dropdown">{{ selectedDuration.label }}<span class="caret"></span></button>\n                            <ul class="dropdown-menu">\n                                <li ng-repeat="duration in durations" ng-click="selectDuration(duration)"><a>{{ duration.label }}</a></li>\n                            </ul>\n                        </div>\n                    </div>\n                    <div class="key-value-section">\n                        <span class="bold-label">To</span>\n                        <span class="label-text to-value">{{ internalRangeObject.suggestedRange().to | date: \'H:mm\' }}</span>\n                    </div>\n                </div>\n            </div>\n            <div class="section-configure">\n                <div class="key-value-section">\n                    <span class="bold-label">Range</span>\n                    <div class="btn-group">\n                        <button class="btn btn-small dropdown-toggle" data-toggle="dropdown">{{ internalRangeObject.selectedRange.label }}<span class="caret"></span></button>\n                        <ul class="dropdown-menu">\n                            <li ng-repeat="range in dictionary"><a ng-click="selectRangeOption(range)">{{ range.label }}</a></li>\n                        </ul>\n                    </div>\n                </div>\n                <div class="key-value-section">\n                    <span class="bold-label">Time Unit</span>\n                    <span class="label-text" ng-hide="internalRangeObject.selectedRange.timeUnits.length > 1">{{ internalRangeObject.timeUnit }}</span>\n                    <div class="btn-group" ng-show="internalRangeObject.selectedRange.timeUnits.length > 1">\n                        <button class="btn btn-small dropdown-toggle" data-toggle="dropdown">{{ internalRangeObject.timeUnit }}<span class="caret"></span>\n                        </button>\n                        <ul class="dropdown-menu">\n                            <li ng-repeat="unit in internalRangeObject.selectedRange.timeUnits" ng-click="selectTimeUnit(unit)"><a>{{ unit }}</a></li>\n                        </ul>\n                    </div>\n                </div>\n            </div>\n        </div>\n        <div class="bottom-section">\n            <div class="button-section">\n                <button class="btn btn-primary finish right" ng-click="save()">Apply</button>\n                <button class="btn finish right" ng-click="close()">Cancel</button>\n            </div>\n            <div class="selected-section">\n                <span class="bold-label">Selected</span>\n                <span class="label-text">{{ internalRangeObject.suggestedRange().from | date: \'EEE d MMM yyyy H:mm\' }} &nbsp;&ndash;&nbsp; {{ internalRangeObject.suggestedRange().to | date: \'EEE d MMM yyyy H:mm\' }} {{ threeLetterTimezoneLabel }}</span>\n            </div>\n        </div>\n    </div>\n</div>')}var i=[{label:"Last Hour",duration:{unit:"hour",value:1}},{label:"Last 24 Hours",duration:{unit:"day",value:1},preselected:!0},{label:"Last 7 Days",duration:{unit:"week",value:1}},{label:"Date Range",custom:"date"},{label:"Time Range",custom:"time"}],j=[{value:-1,unit:"hour",label:"An hour ago"},{value:0,label:"0:00"},{value:1,label:"1:00"},{value:2,label:"2:00"},{value:3,label:"3:00"},{value:4,label:"4:00"},{value:5,label:"5:00"},{value:6,label:"6:00"},{value:7,label:"7:00"},{value:8,label:"8:00"},{value:9,label:"9:00"},{value:10,label:"10:00"},{value:11,label:"11:00"},{value:12,label:"12:00"},{value:13,label:"13:00"},{value:14,label:"14:00"},{value:15,label:"15:00"},{value:16,label:"16:00"},{value:17,label:"17:00"},{value:18,label:"18:00"},{value:19,label:"19:00"},{value:20,label:"20:00"},{value:21,label:"21:00"},{value:22,label:"22:00"},{value:23,label:"23:00"}],k=[{value:1,unit:"hours",label:"1 hour"},{value:2,unit:"hours",label:"2 hours"},{value:3,unit:"hours",label:"3 hours"},{value:6,unit:"hours",label:"6 hours"},{value:12,unit:"hours",label:"12 hours"},{value:24,unit:"hours",label:"24 hours"},{value:48,unit:"hours",label:"48 hours"}];"function"==typeof define&&"object"==typeof define.amd&&define.amd?define(["angular","jQuery","datepick","lodash","moment"],function(a,b,c,d,e){return g(a,b,_)}):"undefined"!=typeof angular&&null!==angular&&g(angular,$,_)}).call(this);