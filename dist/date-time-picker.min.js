/**
 * Another angular directive for selecting date and time ranges
 * @version v0.1.0 - 2015-07-24
 * @author Gabriela Vazquez <gabs.vz@gmail.com>
 **/
(function(){"use strict";function a(a){return"hour"===a.duration.unit||"minutes"===a.duration.unit||"day"==a.duration.unit&&1==a.duration.value?!0:!1}function b(a,b){var c=new moment(a),d=new moment(b);return d.diff(c,"hours")}function c(a){var b=a||new Date,c=b+"",d=c.match(/\(([^\)]+)\)$/)||c.match(/([A-Z]+) [\d]{4}$/);return d&&(d=d[1].match(/[A-Z]/g).join("")),d||(d=""),d}function d(a,b,c){function d(a){var b=i.indexOf(a);return 0>b||b>i.length-2?i[i.length-1]:i[b+1]}function e(a){switch(a){case"second":return 1e3;case"minute":return 6e4;case"hour":return 36e5;case"day":return 864e5;case"week":return 6048e5;case"month":return 2592e6;default:return NaN}}function f(a){if(_.isUndefined(a)&&(a=h.timeUnit),i.indexOf(a)<0)return void 0;var b=e(a),c=moment(h.from).toDate().getTime(),d=moment(h.to).toDate().getTime(),f=d-c;return Math.floor(f/b)}function g(a){var b=f(a);return b?f(a)<h.maxResolution:!1}var h,i=["second","minute","hour","day","week","month"];return h={from:a,to:b,timeUnit:c||"second",maxResolution:200,selectedRange:"custom",suggestedTimeUnit:function(){for(var a=h.timeUnit,b=i[i.length-1];a!==b&&!g(a);)a=d(a);return a},suggestedRange:function(){var a=h.suggestedTimeUnit(),b={from:moment(h.from).startOf(a).valueOf(),to:moment(h.to).startOf(a).valueOf(),intersects:function(a){return moment(a).valueOf()>=b.from&&moment(a).valueOf()<=b.to}};return b}}}function e(a,b){var c,e,f;if(a.duration&&0===a.duration.offset)c=moment(),e=moment().startOf(a.duration.unit).subtract(a.duration.value-1,a.duration.unit);else if(a.duration&&a.duration.offset>0){var g=(new moment).subtract(a.duration.offset,a.duration.unit),h=(new moment).subtract(a.duration.offset-1,a.duration.unit);e=moment(g).startOf(a.duration.unit),c=moment(h).startOf(a.duration.unit)}else c=moment(),e=moment().subtract(a.duration.value,a.duration.unit);f=d(e.valueOf(),c.valueOf());var i=b||f.suggestedTimeUnit();return f.to=moment(f.to).startOf(i).valueOf(),f.from=moment(f.to).subtract(a.duration.value,a.duration.unit).valueOf(),f.timeUnit=i,f.selectedRange=a,f}function f(f,h){return g(f),{restrict:"E",replace:!0,templateUrl:"date-time-picker.html",scope:{range:"=",options:"=",rangeDictionary:"="},link:function(g,i){function m(a,b){var c=moment(b).diff(moment(a),"hours");c>36&&200>c?g.internalRangeObject.selectedRange.timeUnits=["hour","day"]:delete g.internalRangeObject.selectedRange.timeUnits}function n(){if("Time Range"===g.internalRangeObject.selectedRange.label){var a=moment(g.internalRangeObject.from),c=moment(g.internalRangeObject.to);g.selectedFrom=h.find(g.hours,{value:a.hour()}),10===c.diff(a,"minutes")?g.selectedDuration=h.find(g.durations,{value:10,unit:"minutes"}):g.selectedDuration=h.find(g.durations,{value:c.diff(a,"hours"),unit:"hours"})}else if("Last Hour"===g.internalRangeObject.selectedRange.label)g.selectedFrom=h.find(g.hours,{value:-1}),g.selectedDuration=h.find(g.durations,{value:1,unit:"hours"});else if("Last 10 Minutes"===g.internalRangeObject.selectedRange.label)g.selectedFrom=h.find(g.hours,{value:-10}),g.selectedDuration=h.find(g.durations,{value:10,unit:"minutes"});else{var d=new moment(g.internalRangeObject.suggestedRange().from).hour();g.selectedFrom=h.find(g.hours,{value:d});var e=b(g.internalRangeObject.from,g.internalRangeObject.to);g.selectedDuration=h.find(g.durations,{value:e,unit:"hours"})}var j=new Date(g.internalRangeObject.suggestedRange().from);t=!0,f(i.find(".single-calendar-container")).datepick("setDate",j)}function o(){var a=g.internalRangeObject.suggestedRange().from,b=new Date(a),c=moment(a).month(),d=moment(a).year(),e=new Date(g.internalRangeObject.suggestedRange().to);v=!1,u=!0,f(i.find(".double-calendar-container")).datepick("option","minDate","-6m"),f(i.find(".double-calendar-container")).datepick("option","maxDate",0),f(i.find(".double-calendar-container")).datepick("setDate",b,e),f(i.find(".double-calendar-container")).datepick("showMonth",d,c),m(g.internalRangeObject.suggestedRange().from,g.internalRangeObject.suggestedRange().to)}function p(){g.isTimeRange?n():o()}function q(b){if(g.internalRangeObject.selectedRange){if(g.internalRangeObject.selectedRange.custom){if("date"===g.internalRangeObject.selectedRange.custom){if(g.isTimeRange){var c=new moment(g.internalRangeObject.from).startOf("day"),f=new moment(g.internalRangeObject.to).endOf("day");g.internalRangeObject=d(c.valueOf(),f.valueOf()),g.internalRangeObject.selectedRange=h.find(g.dictionary,{custom:"date"}),g.isTimeRange=!1}}else if(!g.isTimeRange){var c=new moment(g.internalRangeObject.from).startOf("day"),f=new moment(g.internalRangeObject.from).startOf("day").add(1,"day");g.internalRangeObject=d(c.valueOf(),f.valueOf()),g.internalRangeObject.selectedRange=h.find(g.dictionary,{custom:"time"}),g.isTimeRange=!0}}else g.internalRangeObject=e(g.internalRangeObject.selectedRange,b?g.internalRangeObject.timeUnit:!1),g.isTimeRange=a(g.internalRangeObject.selectedRange);b||(g.internalRangeObject.timeUnit=g.internalRangeObject.suggestedTimeUnit())}}function r(a,b,c){g.internalRangeObject=d(a,b),g.internalRangeObject.selectedRange=h.find(g.dictionary,c),g.internalRangeObject.timeUnit=g.internalRangeObject.suggestedTimeUnit()}function s(){f(i.find(".single-calendar-container")).datepick({minDate:"-6m",maxDate:0,changeMonth:!1,dayNamesMin:["S","M","T","W","T","F","S"],prevText:'<span class="datepickImagePrevious"></span><span class="datepickTextNextPrevious">Prev</span>',nextText:'<span class="datepickTextNextPrevious">Next</span><span class="datepickImageNext"></span>',onSelect:g.singleDateSelected}),f(i.find(".double-calendar-container")).datepick({rangeSelect:!0,monthsToShow:2,minDate:"-6m",maxDate:0,changeMonth:!1,dayNamesMin:["S","M","T","W","T","F","S"],prevText:'<span class="datepickImagePrevious"></span><span class="datepickTextNextPrevious">Prev</span>',nextText:'<span class="datepickTextNextPrevious">Next</span><span class="datepickImageNext"></span>',onSelect:g.dateRangeSelected}),g.rangeDictionary?g.dictionary=g.rangeDictionary:g.dictionary=j,h.find(g.dictionary,{label:"Last 10 Minutes"})?(g.hours=[{value:-10,unit:"minute",label:"Ten minutes ago"}].concat(k),g.durations=[{value:10,unit:"minutes",label:"10 minutes"}].concat(l)):(g.hours=k,g.durations=l),g.options&&g.options.hideCustom&&h.remove(g.dictionary,{custom:"date"}),g.maxRange=g.options&&g.options.maxRange||31,g.internalRangeObject={},g.selectRangeOption(h.find(g.dictionary,{preselected:!0})||g.dictionary[0]),g.threeLetterTimezoneLabel=c();var a=e(g.internalRangeObject.selectedRange);g.range={from:a.from,to:a.to,timeUnit:a.suggestedTimeUnit()},g.savedRange=g.internalRangeObject.selectedRange}var t,u;g.singleDateSelected=function(a){if(a&&a[0]){if(t)return void(t=!1);var b=new moment(a[0]),c=new moment(g.internalRangeObject.from);c.year(b.year()).month(b.month()).date(b.date());var d=new moment(c.valueOf()).add(g.selectedDuration.value,"hours");r(c.valueOf(),d.valueOf(),{custom:"time"}),g.$apply()}};var v;g.dateRangeSelected=function(a){if(a&&a.length){if(u)return void(u=!1);var b,c;if(v)b=v,c=moment(a[1]).endOf("day").valueOf(),f(i.find(".double-calendar-container")).datepick("option","minDate","-6m"),f(i.find(".double-calendar-container")).datepick("option","maxDate",0),f(i.find(".double-calendar-container")).datepick("setDate",new Date(b),new Date(c)),v=!1;else{b=moment(a[0]).startOf("day").valueOf(),c=moment(a[1]).endOf("day").valueOf(),v=b;var d=moment(b).add(g.maxRange,"days").valueOf(),e=h.min([d,moment().valueOf()]);f(i.find(".double-calendar-container")).datepick("option","minDate",new Date(b)),f(i.find(".double-calendar-container")).datepick("option","maxDate",new Date(e))}r(b,c,{custom:"date"}),m(b,c),g.$apply()}},g.selectRangeOption=function(a){g.internalRangeObject.selectedRange=a,q(),p()},g.configure=function(){g.internalRangeObject.selectedRange=g.savedRange,g.internalRangeObject.from=g.range.from,g.internalRangeObject.to=g.range.to,g.internalRangeObject.timeUnit=g.range.timeUnit,q(!0),p(),g.configuring=!0},g.selectFrom=function(a){if(-1===a.value)g.selectRangeOption(h.find(g.dictionary,{label:"Last Hour"}));else if(-10===a.value)g.selectRangeOption(h.find(g.dictionary,{label:"Last 10 Minutes"}));else{g.selectedFrom=a;var b=new moment(g.internalRangeObject.from);b.hour(a.value).minute(0).second(0).millisecond(0);var c=new moment(b.valueOf()).add(g.selectedDuration.value,g.selectedDuration.unit);r(b.valueOf(),c.valueOf(),{custom:"time"})}},g.selectDuration=function(a){g.selectedDuration=a;var b=new moment(g.internalRangeObject.from).add(g.selectedDuration.value,g.selectedDuration.unit);r(g.internalRangeObject.from,b.valueOf(),{custom:"time"})},g.selectTimeUnit=function(a){g.internalRangeObject.timeUnit=a,q(!0)},g.close=function(){g.configuring=!1},g.refresh=function(){g.internalRangeObject.selectedRange=g.savedRange,q(!0),g.save()},g.save=function(){g.savedRange=g.internalRangeObject.selectedRange,g.range.from=g.internalRangeObject.from,g.range.to=g.internalRangeObject.to,g.range.timeUnit=g.internalRangeObject.timeUnit,g.configuring=!1},s()}}}function g(a){if("undefined"==typeof jQuery)throw new Error("Bootstrap's JavaScript requires jQuery");if(function(a){var b=a.fn.jquery.split(" ")[0].split(".");if(b[0]<2&&b[1]<9||1==b[0]&&9==b[1]&&b[2]<1)throw new Error("Bootstrap's JavaScript requires jQuery version 1.9.1 or higher")}(jQuery),function(a){function b(b){var c=b.attr("data-target");c||(c=b.attr("href"),c=c&&/#[A-Za-z]/.test(c)&&c.replace(/.*(?=#[^\s]*$)/,""));var d=c&&a(c);return d&&d.length?d:b.parent()}function c(c){c&&3===c.which||(a(e).remove(),a(f).each(function(){var d=a(this),e=b(d),f={relatedTarget:this};e.hasClass("open")&&(c&&"click"==c.type&&/input|textarea/i.test(c.target.tagName)&&a.contains(e[0],c.target)||(e.trigger(c=a.Event("hide.dt.dropdown",f)),c.isDefaultPrevented()||(d.attr("aria-expanded","false"),e.removeClass("open").trigger("hidden.dt.dropdown",f))))}))}function d(b){return this.each(function(){var c=a(this),d=c.data("dt.dropdown");d||c.data("dt.dropdown",d=new g(this)),"string"==typeof b&&d[b].call(c)})}var e=".dropdown-backdrop",f='[data-toggle="dt_dropdown"]',g=function(b){a(b).on("click.dt.dropdown",this.toggle)};g.VERSION="3.3.5",g.prototype.toggle=function(d){var e=a(this);if(!e.is(".disabled, :disabled")){var f=b(e),g=f.hasClass("open");if(c(),!g){"ontouchstart"in document.documentElement&&!f.closest(".navbar-nav").length&&a(document.createElement("div")).addClass("dropdown-backdrop").insertAfter(a(this)).on("click",c);var h={relatedTarget:this};if(f.trigger(d=a.Event("show.dt.dropdown",h)),d.isDefaultPrevented())return;e.trigger("focus").attr("aria-expanded","true"),f.toggleClass("open").trigger("shown.dt.dropdown",h)}return!1}},g.prototype.keydown=function(c){if(/(38|40|27|32)/.test(c.which)&&!/input|textarea/i.test(c.target.tagName)){var d=a(this);if(c.preventDefault(),c.stopPropagation(),!d.is(".disabled, :disabled")){var e=b(d),g=e.hasClass("open");if(!g&&27!=c.which||g&&27==c.which)return 27==c.which&&e.find(f).trigger("focus"),d.trigger("click");var h=" li:not(.disabled):visible a",i=e.find(".dropdown-menu"+h);if(i.length){var j=i.index(c.target);38==c.which&&j>0&&j--,40==c.which&&j<i.length-1&&j++,~j||(j=0),i.eq(j).trigger("focus")}}}};var h=a.fn.dt_dropdown;a.fn.dt_dropdown=d,a.fn.dt_dropdown.Constructor=g,a.fn.dt_dropdown.noConflict=function(){return a.fn.dt_dropdown=h,this},a(document).on("click.dt.dropdown.data-api",c).on("click.dt.dropdown.data-api",".dropdown form",function(a){a.stopPropagation()}).on("click.dt.dropdown.data-api",f,g.prototype.toggle).on("keydown.dt.dropdown.data-api",f,g.prototype.keydown).on("keydown.dt.dropdown.data-api",".dropdown-menu",g.prototype.keydown)}(jQuery),"undefined"==typeof jQuery)throw new Error("Bootstrap's JavaScript requires jQuery");!function(a){var b=a.fn.jquery.split(" ")[0].split(".");if(b[0]<2&&b[1]<9||1==b[0]&&9==b[1]&&b[2]<1)throw new Error("Bootstrap's JavaScript requires jQuery version 1.9.1 or higher")}(jQuery),function(a){function b(b){var c=b.attr("data-target");c||(c=b.attr("href"),c=c&&/#[A-Za-z]/.test(c)&&c.replace(/.*(?=#[^\s]*$)/,""));var d=c&&a(c);return d&&d.length?d:b.parent()}function c(c){c&&3===c.which||(a(e).remove(),a(f).each(function(){var d=a(this),e=b(d),f={relatedTarget:this};e.hasClass("open")&&(c&&"click"==c.type&&/input|textarea/i.test(c.target.tagName)&&a.contains(e[0],c.target)||(e.trigger(c=a.Event("hide.dt.dropdown",f)),c.isDefaultPrevented()||(d.attr("aria-expanded","false"),e.removeClass("open").trigger("hidden.dt.dropdown",f))))}))}function d(b){return this.each(function(){var c=a(this),d=c.data("dt.dropdown");d||c.data("dt.dropdown",d=new g(this)),"string"==typeof b&&d[b].call(c)})}var e=".dropdown-backdrop",f='[data-toggle="dt_dropdown"]',g=function(b){a(b).on("click.dt.dropdown",this.toggle)};g.VERSION="3.3.5",g.prototype.toggle=function(d){var e=a(this);if(!e.is(".disabled, :disabled")){var f=b(e),g=f.hasClass("open");if(c(),!g){"ontouchstart"in document.documentElement&&!f.closest(".navbar-nav").length&&a(document.createElement("div")).addClass("dropdown-backdrop").insertAfter(a(this)).on("click",c);var h={relatedTarget:this};if(f.trigger(d=a.Event("show.dt.dropdown",h)),d.isDefaultPrevented())return;e.trigger("focus").attr("aria-expanded","true"),f.toggleClass("open").trigger("shown.dt.dropdown",h)}return!1}},g.prototype.keydown=function(c){if(/(38|40|27|32)/.test(c.which)&&!/input|textarea/i.test(c.target.tagName)){var d=a(this);if(c.preventDefault(),c.stopPropagation(),!d.is(".disabled, :disabled")){var e=b(d),g=e.hasClass("open");if(!g&&27!=c.which||g&&27==c.which)return 27==c.which&&e.find(f).trigger("focus"),d.trigger("click");var h=" li:not(.disabled):visible a",i=e.find(".dropdown-menu"+h);if(i.length){var j=i.index(c.target);38==c.which&&j>0&&j--,40==c.which&&j<i.length-1&&j++,~j||(j=0),i.eq(j).trigger("focus")}}}};var h=a.fn.dt_dropdown;a.fn.dt_dropdown=d,a.fn.dt_dropdown.Constructor=g,a.fn.dt_dropdown.noConflict=function(){return a.fn.dt_dropdown=h,this},a(document).on("click.dt.dropdown.data-api",c).on("click.dt.dropdown.data-api",".dropdown form",function(a){a.stopPropagation()}).on("click.dt.dropdown.data-api",f,g.prototype.toggle).on("keydown.dt.dropdown.data-api",f,g.prototype.keydown).on("keydown.dt.dropdown.data-api",".dropdown-menu",g.prototype.keydown)}(jQuery)}function h(a,b,c){var d=a.module("dt-picker",[]);return d.run(["$templateCache",i]),d.factory("jQuery",[function(){return b}]),d.factory("lodash",[function(){return c}]),d.factory("dtPicker.service",[function(){return{version:"0.1.0"}}]),d.directive("dtPicker",["jQuery","lodash",f]),d}function i(a){a.put("date-time-picker.html",'<div class="date-time-picker">\n    <div>\n        <div class="main-label-container">\n            <a class="main-date-time-label" ng-class="configuring ? \'configuring\' : \'closed\'" ng-click="configure()">\n                <span class="dt-lighter">{{ range.from | date: \'EEE\' }}</span>\n                <span class="dt-bolder">{{ range.from | date: \'d MMM yyyy\' }}</span>\n                <span class="dt-lighter">{{ range.from | date: \'H:mm\' }}</span>\n                <span class="dt-bolder">&nbsp;&ndash;&nbsp;</span>\n                <span class="dt-lighter">{{ range.to | date: \'EEE\' }}</span>\n                <span class="dt-bolder">{{ range.to | date: \'d MMM yyyy\' }}</span>\n                <span class="dt-lighter">{{ range.to | date: \'H:mm\' }}</span>\n                <span class="dt-lighter">{{ threeLetterTimezoneLabel }}</span>\n            </a>\n        </div>\n        <button class="btn-refresh btn btn-sm" href="" ng-click="refresh()"><i class="icon-refresh"></i></button>\n        <div class="clearboth"></div>\n    </div>\n    <div class="date-time-configure" ng-show="configuring">\n        <div class="sections">\n            <div class="date-range-selection" ng-hide="isTimeRange">\n                <div class="double-calendar-container"></div>\n            </div>\n            <div class="time-range-selection" ng-show="isTimeRange">\n                <div class="single-calendar-container"></div>\n                <div class="time-range-container">\n                    <div class="key-value-section">\n                        <span class="bold-label">From</span>\n                        <div class="btn-group">\n                            <button class="btn btn-sm dropdown-toggle" data-toggle="dt_dropdown">{{ selectedFrom.label }}<span class="caret"></span></button>\n                            <ul class="dropdown-menu">\n                                <li ng-repeat="hour in hours" ng-click="selectFrom(hour)"><a>{{ hour.label }}</a></li>\n                            </ul>\n                        </div>\n                    </div>\n                    <div class="key-value-section">\n                        <span class="bold-label">Duration</span>\n                        <div class="btn-group">\n                            <button class="btn btn-sm dropdown-toggle" data-toggle="dt_dropdown">{{ selectedDuration.label }}<span class="caret"></span></button>\n                            <ul class="dropdown-menu">\n                                <li ng-repeat="duration in durations" ng-click="selectDuration(duration)"><a>{{ duration.label }}</a></li>\n                            </ul>\n                        </div>\n                    </div>\n                    <div class="key-value-section">\n                        <span class="bold-label">To</span>\n                        <span class="label-text to-value">{{ internalRangeObject.suggestedRange().to | date: \'H:mm\' }}</span>\n                    </div>\n                </div>\n            </div>\n            <div class="section-configure">\n                <div class="key-value-section">\n                    <span class="bold-label">Range</span>\n                    <div class="btn-group">\n                        <button class="btn btn-sm dropdown-toggle" data-toggle="dt_dropdown">{{ internalRangeObject.selectedRange.label }}<span class="caret"></span></button>\n                        <ul class="dropdown-menu">\n                            <li ng-repeat="range in dictionary"><a ng-click="selectRangeOption(range)">{{ range.label }}</a></li>\n                        </ul>\n                    </div>\n                </div>\n                <div class="key-value-section">\n                    <span class="bold-label">Time Unit</span>\n                    <span class="label-text" ng-hide="internalRangeObject.selectedRange.timeUnits.length > 1">{{ internalRangeObject.timeUnit }}</span>\n                    <div class="btn-group" ng-show="internalRangeObject.selectedRange.timeUnits.length > 1">\n                        <button class="btn btn-sm dropdown-toggle" data-toggle="dt_dropdown">{{ internalRangeObject.timeUnit }}<span class="caret"></span>\n                        </button>\n                        <ul class="dropdown-menu">\n                            <li ng-repeat="unit in internalRangeObject.selectedRange.timeUnits" ng-click="selectTimeUnit(unit)"><a>{{ unit }}</a></li>\n                        </ul>\n                    </div>\n                </div>\n            </div>\n        </div>\n        <div class="bottom-section">\n            <div class="button-section">\n                <button class="btn btn-sm btn-save" ng-click="save()">Apply</button>\n                <button class="btn btn-sm" ng-click="close()">Cancel</button>\n            </div>\n            <div class="selected-section">\n                <span class="bold-label">Selected</span>\n                <span class="label-text">{{ internalRangeObject.suggestedRange().from | date: \'EEE d MMM yyyy H:mm\' }} &nbsp;&ndash;&nbsp; {{ internalRangeObject.suggestedRange().to | date: \'EEE d MMM yyyy H:mm\' }} {{ threeLetterTimezoneLabel }}</span>\n            </div>\n            <div class="clearboth"></div>\n        </div>\n    </div>\n</div>')}var j=[{label:"Last Hour",duration:{unit:"hour",value:1}},{label:"Last 24 Hours",duration:{unit:"day",value:1},preselected:!0},{label:"Last 7 Days",duration:{unit:"week",value:1}},{label:"Date Range",custom:"date"},{label:"Time Range",custom:"time"}],k=[{value:-1,unit:"hour",label:"An hour ago"},{value:0,label:"0:00"},{value:1,label:"1:00"},{value:2,label:"2:00"},{value:3,label:"3:00"},{value:4,label:"4:00"},{value:5,label:"5:00"},{value:6,label:"6:00"},{value:7,label:"7:00"},{value:8,label:"8:00"},{value:9,label:"9:00"},{value:10,label:"10:00"},{value:11,label:"11:00"},{value:12,label:"12:00"},{value:13,label:"13:00"},{value:14,label:"14:00"},{value:15,label:"15:00"},{value:16,label:"16:00"},{value:17,label:"17:00"},{value:18,label:"18:00"},{value:19,label:"19:00"},{value:20,label:"20:00"},{value:21,label:"21:00"},{value:22,label:"22:00"},{value:23,label:"23:00"}],l=[{value:1,unit:"hours",label:"1 hour"},{value:2,unit:"hours",label:"2 hours"},{value:3,unit:"hours",label:"3 hours"},{value:6,unit:"hours",label:"6 hours"},{value:12,unit:"hours",label:"12 hours"},{value:24,unit:"hours",label:"24 hours"},{value:48,unit:"hours",label:"48 hours"}];"function"==typeof define&&"object"==typeof define.amd&&define.amd?define(["angular","jQuery","datepick","lodash","moment"],function(a,b,c,d,e){return h(a,b,_)}):"undefined"!=typeof angular&&null!==angular&&h(angular,$,_)}).call(this);